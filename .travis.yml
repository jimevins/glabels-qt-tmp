language: cpp

# blocklist
branches:
  except:
    - /.*/
    - /^glabels-.*$/ # Do not build tags that we create when we upload to GitHub Releases

# safelist
branches:
  only:
    - master

matrix:
  include:

  #####################
  #
  # Linux build
  #
  #####################
  - name: "Linux"
    os: linux
    dist: bionic
    sudo: require
    
    install:
      - sudo apt-get -y install qtbase5-dev libqt5svg5-dev qttools5-dev
      - sudo apt-get -y install xvfb
      - sudo apt-get -y install pkgconf libqrencode-dev
      - sudo apt-get -y install barcode

    before_script:
      - git fetch --unshallow # restore repository depth to properly count commits in auto versioning
      - git checkout master   # re-attach to master to satisfy auto versioning

    script:
      - mkdir build
      - cd build
      - cmake .. -DCMAKE_INSTALL_PREFIX=/usr
      - make -j4
      - xvfb-run ctest
      - VERSION=$(cat VERSION)

    after_success:
      #
      # Create AppImage
      #
      - # Download AppImage QT deployment tool (local snapshot -- original at github/probono)
      - wget -c "https://github.com/jimevins/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage" 
      - chmod a+x linuxdeployqt*.AppImage
      - #
      - make DESTDIR=appdir install
      - unset QTDIR; unset QT_PLUGIN_PATH ; unset LD_LIBRARY_PATH
      - export LD_LIBRARY_PATH=/opt/qt*/lib/:/usr/local/lib:$LD_LIBRARY_PATH
      - ./linuxdeployqt*.AppImage ./appdir/usr/share/applications/*.desktop -bundle-non-qt-libs
      - ./linuxdeployqt*.AppImage ./appdir/usr/share/applications/*.desktop -appimage
      - mv ./gLabels*.AppImage glabels-${VERSION}-x86_64.AppImage

  #####################
  #
  # Windows build
  #
  #####################
  - name: "Windows"
    os: windows

    before_script:
      - git fetch --unshallow # restore repository depth to properly count commits in auto versioning
      - git checkout master   # re-attach to master to satisfy auto versioning

    script:
      - mkdir build
      - cd build
      #- cmake .. -G "Visual Studio 15 2017 Win64"
      #- cmake --build . --config Release
      #- ctest -C Release
      #- VERSION=$(cat VERSION)

    after_success:
      #
      # Create Windows Installer
      #
      #- cpack -C Release -G NSIS64

  #####################
  #
  # MacOS build
  #
  #####################
  - name: "MacOS"
    os: osx

    install:
      - brew install qt

    before_script:
      - git fetch --unshallow # restore repository depth to properly count commits in auto versioning
      - git checkout master   # re-attach to master to satisfy auto versioning

    script:
      - mkdir build
      - cd build
      - cmake .. -DCMAKE_PREFIX_PATH=/usr/local/opt/qt
      - make -j4
      #- ctest --verbose
      - VERSION=$(cat VERSION)
